#!/bin/sh
#
# Automatically bump PORTREVISION of ports with touched distfiles.

fetch=0
tools_dir=$(cd $(dirname $0) && pwd)

args=`getopt f $*`
if [ $? -ne 0 ]; then
	echo "Usage: $0 [-f] port..."
	exit 2
fi

set -- $args
for i; do
	case "$i"
	in
		-f)
			fetch=1
			shift;;
		--)
			shift; break;;
	esac
done

for d in $@; do
	(
	case $d in
	*texlive-core)
		exit 1;;
	esac
	cd $d || exit 1
	if [ $fetch = 1 ]; then
	    	make distclean
		#${tools_dir}/rm-distfiles
	fi
	port fetch
	if [ -n "`svn status`" ]; then
		installed=$(pkg_info -E "$(make -V UNIQUENAME)-[0-9]*")
		if [ -n "${installed}" ]; then
			sudo pkg_delete "${installed}"
		fi

		${tools_dir}/bump-portrevision
		make clean
		make pkg-plist
		if [ -n "${installed}" ]; then
			sudo make package clean
		fi
	fi
	)
done
